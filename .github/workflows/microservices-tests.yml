name: Microservices Unit Tests

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  unit-tests:
    runs-on: ubuntu-latest

    steps:
      # Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # Install dependencies for XML parsing and JSON
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libxml2-utils jq

      # Determine highest available Maven Alpine Java version
      - name: Determine highest available Java version
        id: java_version
        run: |
          set -e
          echo "Fetching available Maven Alpine Java versions from Docker Hub..."
          tags=$(curl -s https://registry.hub.docker.com/v2/repositories/library/maven/tags?page_size=100 \
            | jq -r '.results[].name' \
            | grep 'eclipse-temurin-[0-9]\+-alpine' \
            | sed -E 's/^3\.9.*eclipse-temurin-([0-9]+)-alpine$/\1/')

          if [ -z "$tags" ]; then
            echo "No Alpine tags found, defaulting to 21"
            echo "max_java=21" >> $GITHUB_OUTPUT
          else
            max_java=$(echo "$tags" | sort -nr | head -n1)
            echo "Highest available Java version: $max_java"
            echo "max_java=$max_java" >> $GITHUB_OUTPUT
          fi

      # Run unit tests for each microservice
      - name: Run unit tests
        run: |
          set -e
          MAX_JAVA_AVAILABLE=${{ steps.java_version.outputs.max_java }}
          echo "Max available Java version is $MAX_JAVA_AVAILABLE"

          tested=""
          skipped=""

          services=$(find . -maxdepth 4 -name pom.xml -exec dirname {} \;)
          for service in $services; do
            echo "Checking microservice: $service"
            cd "$service"

            # Prepare Maven wrapper if it exists
            if [ -f mvnw ]; then
              chmod +x mvnw
              sed -i 's/\r$//' mvnw
            fi

            # Extract Java version from pom.xml (maven-compiler-plugin release)
            java_ver=$(xmllint --xpath "//*[local-name()='plugin'][*//*[local-name()='artifactId']='maven-compiler-plugin']/*[local-name()='configuration']/*[local-name()='release']/text()" pom.xml 2>/dev/null || echo "20")
            if [ -z "$java_ver" ]; then java_ver="20"; fi
            echo "Detected Java version: $java_ver"

            if [ "$java_ver" -gt "$MAX_JAVA_AVAILABLE" ]; then
              echo "Skipping $service: Java $java_ver not supported (max $MAX_JAVA_AVAILABLE)."
              skipped="$skipped $service"
              cd - >/dev/null
              continue
            fi

            # Pick the smallest Docker image >= required Java
            success=false
            for ver in $(seq $java_ver $MAX_JAVA_AVAILABLE); do
              image="maven:3.9-eclipse-temurin-${ver}-alpine"
              if docker manifest inspect $image >/dev/null 2>&1; then
                echo "Using Docker image $image for $service"
                docker run --rm -v "$PWD":/app -w /app $image bash -c 'if [ -f mvnw ]; then ./mvnw clean test; else mvn clean test; fi'
                tested="$tested $service"
                success=true
                break
              fi
            done

            if [ "$success" = false ]; then
              echo "Unit tests failed for $service on all available Docker images"
              skipped="$skipped $service"
            fi

            cd - >/dev/null
          done

          echo ""
          echo "====== Unit Test Summary ======"
          echo "Tested microservices: $tested"
          echo "Skipped microservices: $skipped"
          echo "==============================="
